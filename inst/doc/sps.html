<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Drawing a Sequential Poisson Sample</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Drawing a Sequential Poisson Sample</h1>



<p>Sequential Poisson sampling is a variation of Poisson sampling for
drawing probability-proportional-to-size samples with a given number of
units. It’s a fast, simple, and flexible method for sampling units
proportional to their size, and is often used for drawing a sample of
businesses. The purpose of this vignette is to give an example of how
the functions in this package can be used to easily draw a sample using
the sequential Poisson method. More details can be found on the help
pages for the functions used in this vignette.</p>
<div id="drawing-a-sample-of-businesses" class="section level2">
<h2>Drawing a sample of businesses</h2>
<p>Consider the problem of drawing a sample of businesses in order to
measure the value of sales for the current quarter. The frame is a
business register that gives an enumeration of all businesses in
operation, along with the revenue of each business from the previous
year and the region in which they are headquartered.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(sps)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123654</span>)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>frame <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>  <span class="at">revenue =</span> <span class="fu">round</span>(<span class="fu">rlnorm</span>(<span class="fl">1e3</span>) <span class="sc">*</span> <span class="dv">1000</span>),</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>  <span class="at">region =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="fl">1e3</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span>), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="fu">head</span>(frame)</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="co">#&gt;   revenue region</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="co">#&gt; 1    2676      1</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="co">#&gt; 2    2158      1</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="co">#&gt; 3    2046      3</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="co">#&gt; 4     537      2</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="co">#&gt; 5     266      3</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="co">#&gt; 6    1991      1</span></span></code></pre></div>
<p>Associated with each business is a value for their sales for the
current quarter, although these values are not observable for all
businesses. The purpose of drawing a sample is to observe sales for a
subset of businesses, and extrapolate the value of sales from the sample
of business to the entire population. Sales are positively correlated
with last year’s revenue, and this is the basis for sampling businesses
proportional to revenue.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>sales <span class="ot">&lt;-</span> <span class="fu">round</span>(frame<span class="sc">$</span>revenue <span class="sc">*</span> <span class="fu">runif</span>(<span class="fl">1e3</span>, <span class="fl">0.5</span>, <span class="dv">2</span>))</span></code></pre></div>
<p>Budget constraints mean that it’s feasible to draw a sample of 100
businesses. Businesses operate in different regions, and so the sample
will be stratified by region. This requires determining how the total
sample size of 100 is allocated across regions. A common approach is to
do this allocation proportional to the total revenue in each region.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>allocation <span class="ot">&lt;-</span> <span class="fu">with</span>(frame, <span class="fu">prop_allocation</span>(revenue, <span class="dv">100</span>, region))</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>allocation</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co">#&gt;  1  2  3 </span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co">#&gt; 19 32 49</span></span></code></pre></div>
<p>With the sample size for each region in hand, it’s now time to draw a
sample and observe the value of sales for these businesses. In practice
this is usually the result of a survey that’s administered to the
sampled units.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>sample <span class="ot">&lt;-</span> <span class="fu">with</span>(frame, <span class="fu">sps</span>(revenue, allocation, region))</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>survey <span class="ot">&lt;-</span> <span class="fu">cbind</span>(frame[sample, ], <span class="at">sales =</span> sales[sample])</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="fu">head</span>(survey)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="co">#&gt;    revenue region sales</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="co">#&gt; 8     1422      3  1571</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="co">#&gt; 25    2741      2  1843</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="co">#&gt; 31     580      1   897</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="co">#&gt; 37    4508      2  8659</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a><span class="co">#&gt; 38    1007      3  1804</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="co">#&gt; 42    2380      3  4740</span></span></code></pre></div>
<p>An important piece of information from the sampling process is the
design weights, as these enable estimating the value of sales in the
population with the usual Horvitz-Thompson estimator.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>survey<span class="sc">$</span>weight <span class="ot">&lt;-</span> <span class="fu">weights</span>(sample)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="fu">head</span>(survey)</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co">#&gt;    revenue region sales    weight</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="co">#&gt; 8     1422      3  1571 11.254659</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="co">#&gt; 25    2741      2  1843  6.070412</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="co">#&gt; 31     580      1   897 27.752969</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="co">#&gt; 37    4508      2  8659  3.690994</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="co">#&gt; 38    1007      3  1804 15.892875</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="co">#&gt; 42    2380      3  4740  6.724422</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>ht <span class="ot">&lt;-</span> <span class="fu">with</span>(survey, <span class="fu">sum</span>(sales <span class="sc">*</span> weight))</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>ht</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co">#&gt; [1] 2039582</span></span></code></pre></div>
<p>The Horvitz-Thompson estimator is (asymptotically) unbiased under
sequential Poisson sampling, so it should be no surprise that the
estimate is fairly close the true (but unknown) value of sales among all
businesses.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>ht <span class="sc">/</span> <span class="fu">sum</span>(sales) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="co">#&gt; [1] 0.01325931</span></span></code></pre></div>
<p>But in practice it’s not possible to determine how far an estimate is
from the true value in the population. Instead, a common measure of the
quality of a estimate is the coefficient of variation, and this requires
estimating the variance of the Horvitz-Thompson estimator.</p>
<p>A general approach for estimating the variance of the
Horvitz-Thompson estimator is to construct bootstrap replicate weights
from the design weights for the sample, compute a collection of
estimates for the total based on these replicate weights, and then
compute the variance of this collection of estimates.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>repweights <span class="ot">&lt;-</span> <span class="fu">sps_repweights</span>(<span class="fu">weights</span>(sample), <span class="at">tau =</span> <span class="dv">2</span>)</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>var <span class="ot">&lt;-</span> <span class="fu">attr</span>(repweights, <span class="st">&quot;tau&quot;</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>  <span class="fu">mean</span>((<span class="fu">colSums</span>(survey<span class="sc">$</span>sales <span class="sc">*</span> repweights) <span class="sc">-</span> ht)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="fu">sqrt</span>(var) <span class="sc">/</span> ht</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="co">#&gt; [1] 0.09666341</span></span></code></pre></div>
<p>There is also an analytic estimator for the variance of the
Horvitz-Thompson estimator under sequential Poisson sampling. It’s less
flexible than the bootstrap estimator, but is more precise.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>sps_var <span class="ot">&lt;-</span> <span class="cf">function</span>(y, w) {</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>  y <span class="ot">&lt;-</span> y[w <span class="sc">&gt;</span> <span class="dv">1</span>]</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>  w <span class="ot">&lt;-</span> w[w <span class="sc">&gt;</span> <span class="dv">1</span>]</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>  n <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">sum</span>(y <span class="sc">*</span> w)</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  n <span class="sc">/</span> (n <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="fu">sum</span>((<span class="dv">1</span> <span class="sc">-</span> <span class="dv">1</span> <span class="sc">/</span> w) <span class="sc">*</span> (w <span class="sc">*</span> y <span class="sc">-</span> Y <span class="sc">/</span> n)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>}</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>var <span class="ot">&lt;-</span> <span class="fu">with</span>(</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>  survey,</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>  <span class="fu">mapply</span>(sps_var, <span class="fu">split</span>(sales, region), <span class="fu">split</span>(weight, region))</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>)</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a><span class="fu">sqrt</span>(<span class="fu">sum</span>(var)) <span class="sc">/</span> ht</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a><span class="co">#&gt; [1] 0.03067625</span></span></code></pre></div>
</div>
<div id="coordinating-samples" class="section level2">
<h2>Coordinating samples</h2>
<p>Suppose another sample of businesses from the same frame is needed
for a purpose other than measuring the value of sales. It is often
desirable to negatively coordinate these samples so that the same
businesses are not inundated with responding to surveys, without
affecting the statistical properties of the sample. This sort of
coordination is easily done by associating to each business a permanent
random number, and suitably “rotating” them to reduce the overlap
between both samples.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>frame<span class="sc">$</span>prn <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1000</span>)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="fu">head</span>(frame)</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="co">#&gt;   revenue region        prn</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="co">#&gt; 1    2676      1 0.72614569</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="co">#&gt; 2    2158      1 0.30042829</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="co">#&gt; 3    2046      3 0.09393538</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="co">#&gt; 4     537      2 0.31786097</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="co">#&gt; 5     266      3 0.23796557</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a><span class="co">#&gt; 6    1991      1 0.80298366</span></span></code></pre></div>
<p>Permanent random numbers can be used with methods other than
sequential Poisson—the procedure is the same for any order sampling
scheme (including simple random sampling).</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>pareto <span class="ot">&lt;-</span> <span class="fu">order_sampling</span>(\(x) x <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> x))</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>sample <span class="ot">&lt;-</span> <span class="fu">with</span>(frame, <span class="fu">sps</span>(revenue, allocation, region, prn))</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>parsample <span class="ot">&lt;-</span> <span class="fu">with</span>(frame, <span class="fu">pareto</span>(revenue, allocation, region, (prn <span class="sc">-</span> <span class="fl">0.5</span>) <span class="sc">%%</span> <span class="dv">1</span>))</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">intersect</span>(sample, parsample)) <span class="sc">/</span> <span class="dv">100</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="co">#&gt; [1] 0.09</span></span></code></pre></div>
<p>Although there is still a meaningful overlap between the units in
both samples, this is roughly half of what would be expected without
using permanent random numbers.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">replicate</span>(<span class="dv">1000</span>, {</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">with</span>(frame, <span class="fu">pareto</span>(revenue, allocation, region))</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>  <span class="fu">length</span>(<span class="fu">intersect</span>(sample, s)) <span class="sc">/</span> <span class="dv">100</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>}) <span class="sc">|&gt;</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>  <span class="fu">summary</span>()</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="co">#&gt;  0.1200  0.2000  0.2300  0.2275  0.2500  0.3500</span></span></code></pre></div>
</div>
<div id="topping-up" class="section level2">
<h2>Topping up</h2>
<p>The sequential part of sequential Poisson sampling means that it’s
easy to grow a sample. Suppose that there is a need to sample 10 more
businesses in region 1 after the sample is drawn. Simply adding 10 units
to the allocation for region 1 results in a new sample that includes all
the previously sampled units, so the extra units can be surveyed without
discarding previously-collected data or affecting the statistical
properties of the sample.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>sample <span class="ot">&lt;-</span> <span class="fu">with</span>(frame, <span class="fu">sps</span>(revenue, allocation, region, prn))</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>sample_tu <span class="ot">&lt;-</span> <span class="fu">with</span>(frame, <span class="fu">sps</span>(revenue, allocation <span class="sc">+</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">0</span>), region, prn))</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="fu">all</span>(sample <span class="sc">%in%</span> sample_tu)</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>As with any proportional-to-size sampling scheme, there is a critical
sample size after which some units become take-all units. If these units
are not already in the sample then they can “bump” previously sampled
units, requiring a larger sample size to keep all the previously sampled
units in the new sample.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>becomes_ta <span class="ot">&lt;-</span> <span class="cf">function</span>(x, <span class="at">alpha =</span> <span class="fl">1e-3</span>) {</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>  ord <span class="ot">&lt;-</span> <span class="fu">rev</span>(<span class="fu">order</span>(x, <span class="at">decreasing =</span> <span class="cn">TRUE</span>))</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>  x <span class="ot">&lt;-</span> x[ord]</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">ceiling</span>(<span class="fu">cumsum</span>(x) <span class="sc">/</span> x <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> alpha)) <span class="sc">+</span> <span class="fu">length</span>(x) <span class="sc">-</span> <span class="fu">seq_along</span>(x)</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>  res[<span class="fu">order</span>(ord)]</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>}</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a><span class="fu">Map</span>(\(x) <span class="fu">head</span>(<span class="fu">becomes_ta</span>(x)), <span class="fu">split</span>(frame<span class="sc">$</span>revenue, frame<span class="sc">$</span>region))</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a><span class="co">#&gt; $`1`</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a><span class="co">#&gt; [1]  86  98 102 174 161 160</span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a><span class="co">#&gt; $`2`</span></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a><span class="co">#&gt; [1] 278 157 261 254 110 284</span></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a><span class="co">#&gt; $`3`</span></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a><span class="co">#&gt; [1] 283 500 500 344 449 482</span></span></code></pre></div>
<p>But this is rare in practice. For this example there is no point at
which increasing the sample size drops a unit that was previously
included in the sample. Seeing this in action requires different
data.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">13026</span>)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rlnorm</span>(<span class="dv">10</span>)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>u <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">10</span>)</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="fu">becomes_ta</span>(x)</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="co">#&gt;  [1] 10  4  5  5  5  9  8 10  9  9</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>sample <span class="ot">&lt;-</span> <span class="fu">sps</span>(x, <span class="dv">4</span>, <span class="at">prn =</span> u)</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>sample <span class="sc">%in%</span> <span class="fu">sps</span>(x, <span class="dv">5</span>, <span class="at">prn =</span> u)</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="co">#&gt; [1]  TRUE  TRUE  TRUE FALSE</span></span></code></pre></div>
<p>The solution to this problem is to simply increase the size of the
sample until all previously sampled units are included.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>sample <span class="sc">%in%</span> <span class="fu">sps</span>(x, <span class="dv">6</span>, <span class="at">prn =</span> u)</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="co">#&gt; [1] TRUE TRUE TRUE TRUE</span></span></code></pre></div>
</div>
<div id="bias-in-the-horvitz-thompson-estimator" class="section level2">
<h2>Bias in the Horvitz-Thompson estimator</h2>
<p>Despite it’s simplicity, sequential Poisson sampling is only
asymptotically proportional to size. This means that the
Horvitz-Thompson estimator can be biased in small samples, although this
bias is usually negligible for real-world sample sizes.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>sampling_distribution <span class="ot">&lt;-</span> <span class="fu">replicate</span>(<span class="dv">1000</span>, {</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>  sample <span class="ot">&lt;-</span> <span class="fu">with</span>(frame, <span class="fu">sps</span>(revenue, allocation, region))</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>  <span class="fu">sum</span>(sales[sample] <span class="sc">*</span> <span class="fu">weights</span>(sample))</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>})</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="fu">summary</span>(sampling_distribution <span class="sc">/</span> <span class="fu">sum</span>(sales) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="co">#&gt;       Min.    1st Qu.     Median       Mean    3rd Qu.       Max. </span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a><span class="co">#&gt; -0.1043517 -0.0208040  0.0016497  0.0005927  0.0215847  0.1426320</span></span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
